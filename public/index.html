<!DOCTYPE html>
<html lang="ch">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>首页</title>

		<link rel="stylesheet" type="text/css" href="stylesheets/index.css" />

		<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
		<link rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
			integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
			crossorigin="anonymous">

		<script src="javascripts/jquery.min.js"></script>
		<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
			integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
			crossorigin="anonymous"></script>

	</head>

	<body>
		<div class="container">
			<div class="row" style="background: #CCCCCC;height: 60px;">
				<!--个人信息-->
				<div class="col-md-5 people">
					<div class="peotx1"><img class="peotx" src="" alt=""></div>

					<span id="user_text"></span>
				</div>
				<!--登录注册-->
				<div class="col-md-2" style="line-height: 60px;font-size:
					20px;" id="type_l">
					<span data-toggle="modal" data-target="#login_in">登录</span> /
					<span data-toggle="modal" data-target="#login_up">注册</span>
				</div>
				<!--退出登录，个人中心-->
				<div class="col-md-4" id="type_t">
					<span class="btn btn-info" id="t_btn">退出登录</span>
					<span data-toggle="modal" class="updatamsg btn btn-info"
						data-target="#personal_btn">个人中心</span>
				</div>
			</div>
			<!--搜索-->
			<div class="row" id="search">
				<div class="input-group row">
					<input type="text" class="form-control" id="text" placeholder="搜索小说">
					<div class="input-group-addon" id="btn">搜索</div>
				</div>
			</div>
			<!--热推小说-->
			<div class="row" id="con">
				<ul id="ul">
				</ul>
			</div>

			<!--搜索列表-->
			<div class="row" id="search_list">
				<div class="liebiao">
					<button class="fanhui">back</button>
					搜索列表
				</div>
				<ul id="list">
				</ul>
			</div>
			<!--书架我的-->
			<div class="row" id="bookshelf">
				<div class="shujia">
					书架
				</div>
				<div data-toggle="modal" class="fabu" data-target="#my">我要发布</div>
			</div>
		</div>
		<!--注册-->
		<div class="modal fade" tabindex="-1" role="dialog"
			aria-labelledby="mySmallModalLabel" id="login_up">
			<div class="modal-dialog modal-sm" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">注册</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="img">头像
								<input style="display:none;" type="file" class="files" id="img">
								<div id="img"><img class="tx" src="" alt=""></div>
							</label>
						</div>
						<div class="form-group">
							<label for="name">昵称</label>
							<input type="text" class="form-control" id="name_up" placeholder="昵称">
						</div>
						<div class="form-group">
							<label for="user">账号</label>
							<input type="text" class="form-control" id="user_up" placeholder="账号">
						</div>
						<div class="form-group">
							<label for="pass">密码</label>
							<input type="password" class="form-control" id="pass_up"
								placeholder="密码">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn" id="btn_up">确定</button>
					</div>
				</div>
			</div>
		</div>
		<!--结束-->
		<!--登录-->
		<div class="modal fade" tabindex="-1" role="dialog"
			aria-labelledby="mySmallModalLabel" id="login_in">
			<div class="modal-dialog modal-sm" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">登录</h4>
					</div>
					<div class="modal-body">

						<div class="form-group">
							<label for="user">账号</label>
							<input type="text" class="form-control" id="user_in" placeholder="账号">
						</div>
						<div class="form-group">
							<label for="pass">密码</label>
							<input type="password" class="form-control" id="pass_in"
								placeholder="密码">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn" id="btn_in">确定</button>
					</div>
				</div>
			</div>
		</div>
		<!--结束-->

		<!--个人中心-->
		<div class="modal fade" tabindex="-1" role="dialog"
			aria-labelledby="mySmallModalLabel" id="personal_btn">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">个人信息</h4>
					</div>
					<div class="modal-body" style="height: 200px;">
						<div class="col-md-12" id="personal_con">
							<label for="tximg"><input style="display:none;" type="file"
									class="txfile" id="tximg">
								<img id="myimg" src="" alt="">
							</label>
							<input type="text" id="nicheng" />
						</div>
					</div>
					<!--取消确定-->
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						<button type="button" data-dismiss="modal" class="update btn btn-primary
							btn-default">确定</button>
					</div>
				</div>
			</div>
		</div>
		<!--我的-->
		<div class="modal fade" id="my" tabindex="-1" role="dialog"
			aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content createcontent">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">创建</h4>
					</div>
					<div class="createstatus">
						<button class="createlist">
							已创建的追加
						</button>
						<button class="newcreate">
							新创建
						</button>
					</div>
					<div class="modal-body list">
						<div class="box" style="height:auto;margin: 0 auto;">
							<ul class="mylist" style="list-style: none;padding: 0;">
							</ul>
						</div>
					</div>
					<div class="modal-body create">
						<div class="form-group">
							<label for="my_img">封面
								<input style="display: none;" type="file" class="bookimg" id="my_img">
								<div id="my_img"><img id="bookimgs" src="" alt=""></div>
							</label>
						</div>
						<div class="form-group">
							<label for="text">书名</label>
							<input type="text" class="form-control" id="title" placeholder="书名">
						</div>
						<div class="form-group">
							<label for="text">作者</label>
							<input type="text" class="form-control" id="author" placeholder="作者">
						</div>
						<div class="form-group">
							<label for="text">简介</label>
							<input type="text" class="form-control" id="briefing" placeholder="简介">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default reset" data-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" id="my_btn">确定</button>
					</div>
				</div>
			</div>
		</div>
		<!---->
	</body>
	<script>
		var href = 'http://localhost:8000';
		var imgurl = "";
		  var bookimgurl='';
		  $.ajax({
			  url:href+"/logup/resou",
			  type:"post",
			  success(data){
				  var arr=[];
				  var newarr=[];
				  $.each(data,function(i,o){
					  arr.push(o.rsid);
					})
					arr.sort(function(a,b){
						return b-a;
					})
					for(var i=0;i<data.length;i++){
						for(var j=0;j<data.length;j++){
							if(data[j].rsid==arr[i]){
								if(newarr.indexOf(data[j])==-1){
									newarr.push(data[j]);
									break;
								}else{
									continue;
								}
							}
						}
					}
					var newarr1=newarr.splice(0,6);
					$.each(newarr1,function(i,o){
 						var li=$(`
					  <li>
						<a href="details.html">
							<img src="${o.bookimg}" id='imgs' alt="">
							<div id="book_title">${o.name}</div>
							<div id="book_author">${o.author}</div>
						</a>
					</li>`);
					$("#ul").append(li);
					$(li).on("click",function(i){
						localStorage.bookdet=JSON.stringify(o);
						})
					})
			  }
		  })
		  //返回
 		 $('.fanhui').on('click',()=>{
			  $("#list").empty();
 		  con.style.display = 'block';
 		  search_list.style.display = 'none';
		   search.style.display='block';
 		 })
		//   修改个人信息
		$(".updatamsg").on("click",function(){
			var upimg="";
			//修改头像上传
		$(".txfile").on("change", function() {
  		 var files = $(this)[0].files[0];
  		 var d = new FormData;
  		 d.append("name", files);
  		 $.ajax({
  		  url: href + "/cover/upcover",
  		  type: "post",
  		  data: d,
  		  contentType: false,
  		  processData: false,
  		  success(data) {
			upimg = href + data;
  		   $("#myimg").attr("src",upimg);
			}
  		 })
  		})
			$("#nicheng").val(JSON.parse(localStorage.user).name);
			$("#myimg").attr("src",JSON.parse(localStorage.user).img);
			$(".update").on("click",function(){
<<<<<<< HEAD
				if($("#nicheng").val()==JSON.parse(localStorage.user).name || $("#nicheng").val()=="" || upimg == ''){
					alert("新昵称为空或跟旧昵称相同");
=======
				if($("#nicheng").val()==JSON.parse(localStorage.user).name || $("#nicheng").val()=="" || upimg==""){
					alert("新昵称为空或跟旧昵称相同或者头像未修改");
>>>>>>> 31ea494f01f2e014394b7a44aa8c94fcaa3900df
					return;
				}
			$.ajax({
				url:href+"/logup/updat",
				type:"post",
				data:{
					img:upimg,
					nicheng:$("#nicheng").val(),
					uid:JSON.parse(localStorage.user).uid
				},
				success(data){
					alert(data);
					localStorage.clear();
					$(".peotx").attr("src", '');
					$("#user_text").text('未登录');
					type_l.style.display = 'block';
					type_t.style.display = 'none';
					bookshelf.style.display = 'none';
				}
			})
		})
		})
		
		//搜索
		btn.onclick = function() {
			if($("#text").val()==""){
				alert("输入为空"); 
				return;
			}
			$.ajax({
				url:href+"/logup/seatch",
				type:"post",
				data:{
					hotkey:$("#text").val()
				},
				success(data){
					$.each(data,function(i,o){
						var li=$(`<li>
						<a href="details.html">
							<img src="${o.bookimg}" alt="" /></a>
						<h1 id="cover-book-title">${o.name}</h1>
						<h5 id="cover-book-title cover-book-title1">${o.author}</h5>
						<p>${o.briefing}</p>
					</li>`);
					$("#list").append(li);
					$(li).on("click",function(){
						localStorage.bookdet=JSON.stringify(o);
						})
					})
				}
			})
			con.style.display = 'none';
			search_list.style.display = 'block';
			search.style.display='none';
		}
		
  		//封面上传
  		$(".bookimg").on("change", function() {
  		 var files = $(this)[0].files[0];
  		 var d = new FormData;
  		 d.append("name", files);
  		 $.ajax({
  		  url: href + "/bimg/bookimg",
  		  type: "post",
  		  data: d,
  		  contentType: false,
  		  processData: false,
  		  success(data) {
  		   bookimgurl = href + data;
  		   $("#bookimgs").attr("src",bookimgurl);
			}
  		 })
  		})
  
  		//创建小说名
  		$("#my_btn").on("click", () => {
		if($("#title").val()=="" || $("#author").val()=="" || $("#briefing").val()==""){
			alert("请完整小说信息");
			return;
		}
  		 $.ajax({
  		  url: href + "/logup/bookup",
  		  type: "post",
  		  data: {
  			bookname: $("#title").val(),
			author: $("#author").val(),
			briefing:$("#briefing").val(), 
			bookimgurl: bookimgurl,
			useruid:JSON.parse(localStorage.user).uid
  		  },
  		  success(data) {
			localStorage.bookmsg = JSON.stringify(data);
			$("#title").val('');
		 	$("#author").val('');
			$("#briefing").val('');
			bookimgurl='';
			location.href="createbook.html";
  		  }
  		 })
  		})
		//取消创建
		$('.reset').on('click',()=>{
		 $("#title").val('');
		 $("#author").val('');
		 $("#briefing").val('')
		 bookimgurl='';
		})
		//图片上传 注册头像上传
		$(".files").on("change", function() {
			var files = $(this)[0].files[0];
			var d = new FormData;
			d.append("tx", files);
			$.ajax({
				url: href + "/cover/cover",
				type: "post",
				data: d,
				contentType: false,
				processData: false,
				success(data) {
				imgurl = href + data;
				$(".tx").attr("src", imgurl);
				}
			})
		})
		// 中文检测
		function isChineseChar(str){   
		   var reg = /[\u4E00-\u9FA5\uF900-\uFA2D]/;
		   return reg.test(str);
		}
		//注册
		$("#btn_up").on("click", () => {
			if($("#user_up").val()=="" || $("#pass_up").val()=="" || $("#name_up").val()=="" || imgurl==""){
				alert("密码或账号不能为空");
				return;
			}else if(isChineseChar($("#user_up").val()) || isChineseChar($("#pass_up").val())){
				alert("密码和账号不能为中文");
				return;
			}else{
				$('#login_up').modal('toggle');
				$.ajax({
				url: href + "/logup/up",
				type: "post",
				data: {
					name: $("#name_up").val(),
					user: $("#user_up").val(),
					pass: $("#pass_up").val(),
					userimg: imgurl
				},
				success(data) {
					alert(data);
				}
			})
			}
		})
		
		if(localStorage.user){
			var json=JSON.parse(localStorage.user);
			//   书架
			$(".shujia").on("click",function(){
				location.href="booklist.html?uid="+json.uid;
			})
			$(".createlist").on("click",function(){
				
				$.ajax({
					url:href+"/logup/loguid",
					type:"get",
					data:{
						logid:json.uid
					},
					success(data){
						if(data=="没有数据了"){
							alert(data);
							return;
						}
						$.each(data,function(i,o){
							var li=$(`
							<li style="border-bottom:1px solid #cccc;width:100%;height:100px;margin-bottom:10px;">
									<div class="li-book-img" style="width:
										80px;height:100px;float: left;margin-right: 10px;">
										<img src="${o.bookimg}" style="width:100%;height:100%;" alt="">
									</div>
									<div class="li-book-name" style="height:100px;float:left;margin-left: 15px;">
										<h4 style="height: 50px;line-height: 50px;margin: 0;">${o.name}</h4>
										<span style="height: 50px;line-height: 50px;display: block;">${o.author}</span>
									</div>
								</li>
							`);
								$(".mylist").append(li);
								li.on("click",function(){
									localStorage.bookmsg = JSON.stringify(o);
									location.href="createbook.html";
								})
						})
					}
				})
				$(".create").css("display","none");
				$(".list").css("display","block");
			})
			// 创建新书
			$(".newcreate").on("click",function(){
				$(".list").css("display","none");
				$(".create").css("display","block");
			})
			$(".peotx").attr("src", json.img);
			$("#user_text").text(json.name);
			type_l.style.display = 'none';
			type_t.style.display = 'block';
			bookshelf.style.display = 'block';
		}
		// 登录
		$("#btn_in").on("click", () => {
			if($("#user_in").val()=="" || $("#pass_in").val()==""){
				alert("密码或账号不能为空");
				return;
			}else if(isChineseChar($("#user_in").val()) || isChineseChar($("#pass_in").val())){
				alert("密码和账号不能为中文");
				return;
			}else{
				$('#login_in').modal('toggle');
				$.ajax({
				url: href + "/logup/in",
				type: "post",
				data: {
					user: $("#user_in").val(),
					pass: $("#pass_in").val(),
				},
				success(data) {
					if(data.length==0){
						alert('账号或密码错误');
						return;
					}
					localStorage.user = JSON.stringify(data);
					alert(data.tip);
					$(".peotx").attr("src", data.img);
					$("#user_text").text(data.name);
					type_l.style.display = 'none';
					type_t.style.display = 'block';
					bookshelf.style.display = 'block';
				}
			})		
			}
		})
		//退出登录
		$('#t_btn').on('click', () => {
			localStorage.clear();
			$(".peotx").attr("src", '');
			$("#user_text").text('未登录');
			type_l.style.display = 'block';
			type_t.style.display = 'none';
			bookshelf.style.display = 'none';
		})
	</script>
</html>